<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>ğŸ‰ æœ‰ç“œæ•…äº‹ä¼š Â· ç¯å¢ƒé“¾æ¥æ±‡æ€»ï¼ˆå¯ç¼–è¾‘ + å®æ—¶åˆ·æ–°ï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 2em; background: #f9f9f9; }
        section { margin-bottom: 2em; background: #fff; padding: 1em; border: 1px dashed #ccc; }
        h2 { color: #333; }
        ul { list-style: none; padding-left: 0; }
        li { margin-bottom: 0.5em; }
        a { color: #007acc; text-decoration: none; }
        a:hover { text-decoration: underline; }
        input[type="text"] { width: 45%; margin-right: 1em; margin-bottom: 0.5em; }
        button { margin-top: 1em; padding: 0.5em 1em; font-size: 1em; }
    </style>
</head>
<body>
<h1>ğŸ‰ æœ‰ç“œæ•…äº‹ä¼š Â· ç¯å¢ƒé“¾æ¥æ±‡æ€»ï¼ˆå¯ç¼–è¾‘ + å®æ—¶åˆ·æ–°ï¼‰</h1>
<div id="container">åŠ è½½ä¸­...</div>
<button onclick="uploadJsonToCOS()">ğŸ’¾ ä¿å­˜å¹¶ä¸Šä¼ åˆ° COS</button>

<script>
    const JSON_URL = 'https://web-1256805236.cos.ap-guangzhou.myqcloud.com/env.json';
    const COS_BUCKET = 'web-1256805236';
    const COS_REGION = 'ap-guangzhou';
    const COS_KEY = 'env.json';

    let currentVersion = 0;
    let currentData = {};

    // åˆå§‹åŒ– COS å®¢æˆ·ç«¯ï¼ˆè¯·æ›¿æ¢ä¸ºä½ çš„ä¸´æ—¶å¯†é’¥ï¼‰
    const cos = new COS({
        SecretId: 'ä½ çš„ä¸´æ—¶SecretId',
        SecretKey: 'ä½ çš„ä¸´æ—¶SecretKey',
        SecurityToken: 'ä½ çš„ä¸´æ—¶Token'
    });

    async function fetchAndRenderIfUpdated() {
        try {
            const res = await fetch(JSON_URL + '?t=' + Date.now());
            const data = await res.json();
            const newVersion = Number(data.version);

            if (newVersion > currentVersion) {
                currentVersion = newVersion;
                currentData = data;
                renderEditable(data);
            }
        } catch (err) {
            document.getElementById('container').innerHTML = 'âŒ åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ COS é…ç½®æˆ– JSON æ ¼å¼';
            console.error(err);
        }
    }

    function renderEditable(data) {
        const container = document.getElementById('container');
        container.innerHTML = '';

        Object.entries(data).forEach(([env, links]) => {
            if (env === 'version') return;

            const section = document.createElement('section');
            section.innerHTML = `<h2>${env}</h2><ul></ul>`;
            const ul = section.querySelector('ul');

            Object.entries(links).forEach(([label, url]) => {
                const li = document.createElement('li');
                li.innerHTML = `
            <input type="text" value="${label}" data-env="${env}" data-type="label" />
            <input type="text" value="${url}" data-env="${env}" data-type="url" />
          `;
                ul.appendChild(li);
            });

            container.appendChild(section);
        });
    }

    function uploadJsonToCOS() {
        const inputs = document.querySelectorAll('input');
        const newVersion = Date.now();
        const newData = { version: newVersion };

        inputs.forEach(input => {
            const env = input.dataset.env;
            const type = input.dataset.type;
            const value = input.value;

            if (!newData[env]) newData[env] = {};
            if (type === 'label') {
                input.nextElementSibling.dataset.label = value;
            } else if (type === 'url') {
                const label = input.dataset.label || input.previousElementSibling.value;
                newData[env][label] = value;
            }
        });

        const jsonContent = JSON.stringify(newData, null, 2);

        cos.putObject({
            Bucket: COS_BUCKET,
            Region: COS_REGION,
            Key: COS_KEY,
            Body: jsonContent,
            ContentType: 'application/json'
        }, function(err, data) {
            if (!err) {
                alert('âœ… å·²æˆåŠŸä¸Šä¼ åˆ° COS');
                currentVersion = newVersion;
                renderEditable(newData);
            } else {
                alert('âŒ ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†é’¥æˆ–æƒé™');
                console.error(err);
            }
        });
    }

    fetchAndRenderIfUpdated();
    setInterval(fetchAndRenderIfUpdated, 3000);
</script>
</body>
</html>
