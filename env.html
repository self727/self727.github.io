<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>ğŸ‰ æœ‰ç“œæ•…äº‹ä¼š Â· ç¯å¢ƒé“¾æ¥æ±‡æ€»ï¼ˆç¼–è¾‘ + å†å²è®°å½•ï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 2em; background: #f9f9f9; }
        section { margin-bottom: 2em; background: #fff; padding: 1em; border: 1px dashed #ccc; }
        h2 { color: #333; }
        ul { list-style: none; padding-left: 0; }
        li { margin-bottom: 0.5em; }
        input[type="text"] { width: 45%; margin-right: 1em; margin-bottom: 0.5em; }
        button { margin-top: 1em; padding: 0.5em 1em; font-size: 1em; }
    </style>
</head>
<body>
<h1>ğŸ‰ æœ‰ç“œæ•…äº‹ä¼š Â· ç¯å¢ƒé“¾æ¥æ±‡æ€»ï¼ˆç¼–è¾‘ + å†å²è®°å½•ï¼‰</h1>
<div id="container">åŠ è½½ä¸­...</div>
<button onclick="uploadJsonWithHistory()">ğŸ’¾ ä¿å­˜å¹¶ä¸Šä¼ åˆ° COS</button>

<script>
    const JSON_URL = 'https://web-1256805236.cos.ap-guangzhou.myqcloud.com/env.json';
    const HISTORY_KEY = 'env-history.json';
    const COS_BUCKET = 'web-1256805236';
    const COS_REGION = 'ap-guangzhou';
    const ENV_KEY = 'env.json';

    const editor = 'yew'; // å¯æ”¹ä¸ºåŠ¨æ€ç”¨æˆ·å
    let currentData = {};

    const cos = new COS({
        SecretId: 'ä½ çš„ä¸´æ—¶SecretId',
        SecretKey: 'ä½ çš„ä¸´æ—¶SecretKey',
        SecurityToken: 'ä½ çš„ä¸´æ—¶Token'
    });

    async function fetchEnvJson() {
        try {
            const res = await fetch(JSON_URL + '?t=' + Date.now());
            const data = await res.json();
            currentData = data;
            renderEditable(data);
        } catch (err) {
            document.getElementById('container').innerHTML = 'âŒ åŠ è½½å¤±è´¥';
            console.error(err);
        }
    }

    function renderEditable(data) {
        const container = document.getElementById('container');
        container.innerHTML = '';

        Object.entries(data).forEach(([env, links]) => {
            if (env === 'version') return;
            const section = document.createElement('section');
            section.innerHTML = `<h2>${env}</h2><ul></ul>`;
            const ul = section.querySelector('ul');

            Object.entries(links).forEach(([label, url]) => {
                const li = document.createElement('li');
                li.innerHTML = `
            <input type="text" value="${label}" data-env="${env}" data-type="label" />
            <input type="text" value="${url}" data-env="${env}" data-type="url" />
          `;
                ul.appendChild(li);
            });

            container.appendChild(section);
        });
    }

    async function uploadJsonWithHistory() {
        const inputs = document.querySelectorAll('input');
        const newVersion = Date.now();
        const newData = { version: newVersion };
        const historyEntry = {
            version: newVersion,
            timestamp: new Date().toISOString(),
            editor,
            summary: 'æ‰‹åŠ¨ç¼–è¾‘ä¿å­˜',
            data: {}
        };

        inputs.forEach(input => {
            const env = input.dataset.env;
            const type = input.dataset.type;
            const value = input.value;

            if (!newData[env]) newData[env] = {};
            if (!historyEntry.data[env]) historyEntry.data[env] = {};

            if (type === 'label') {
                input.nextElementSibling.dataset.label = value;
            } else if (type === 'url') {
                const label = input.dataset.label || input.previousElementSibling.value;
                newData[env][label] = value;
                historyEntry.data[env][label] = value;
            }
        });

        const envBlob = new Blob([JSON.stringify(newData, null, 2)], { type: 'application/json' });

        cos.putObject({
            Bucket: COS_BUCKET,
            Region: COS_REGION,
            Key: ENV_KEY,
            Body: envBlob,
            ContentType: 'application/json'
        }, async function(err, data) {
            if (!err) {
                alert('âœ… env.json å·²ä¸Šä¼ ');
                await appendToHistory(historyEntry);
            } else {
                alert('âŒ ä¸Šä¼ å¤±è´¥');
                console.error(err);
            }
        });
    }

    async function appendToHistory(entry) {
        try {
            const res = await fetch(`https://${COS_BUCKET}.cos.${COS_REGION}.myqcloud.com/${HISTORY_KEY}?t=${Date.now()}`);
            const history = await res.json();
            history.unshift(entry); // æœ€æ–°è®°å½•æ”¾å‰é¢
            const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });

            cos.putObject({
                Bucket: COS_BUCKET,
                Region: COS_REGION,
                Key: HISTORY_KEY,
                Body: blob,
                ContentType: 'application/json'
            }, function(err, data) {
                if (!err) {
                    alert('ğŸ“œ env-history.json å·²æ›´æ–°');
                } else {
                    alert('âŒ å†™å…¥å†å²è®°å½•å¤±è´¥');
                    console.error(err);
                }
            });
        } catch (err) {
            // å¦‚æœå†å²æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°æ•°ç»„
            const blob = new Blob([JSON.stringify([entry], null, 2)], { type: 'application/json' });

            cos.putObject({
                Bucket: COS_BUCKET,
                Region: COS_REGION,
                Key: HISTORY_KEY,
                Body: blob,
                ContentType: 'application/json'
            }, function(err, data) {
                if (!err) {
                    alert('ğŸ“œ env-history.json å·²åˆ›å»º');
                } else {
                    alert('âŒ åˆ›å»ºå†å²è®°å½•å¤±è´¥');
                    console.error(err);
                }
            });
        }
    }

    fetchEnvJson();
</script>
</body>
</html>
