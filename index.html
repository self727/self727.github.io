<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç¯å¢ƒé“¾æ¥æ±‡æ€» Â· å¯ç¼–è¾‘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; padding: 2em; background: #f9f9f9; }
    h1, h2 { color: #333; }
    input[type="text"] { width: 60%; padding: 4px 8px; margin-right: 8px; }
    button { padding: 6px 12px; margin: 4px 4px 0 0; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #005fa3; }
    section { margin-bottom: 2em; }
    .item-row { margin-bottom: 0.5em; }
    #status { font-size: 14px; color: #888; margin-bottom: 1em; }
    #status.error { color: red; }
  </style>
</head>
<body>

<h1 id="page-title">ğŸ”„ åŠ è½½ä¸­...</h1>
<div id="status">æ­£åœ¨ä» COS åŠ è½½é…ç½®...</div>
<div id="content"></div>

<div>
  <button onclick="addSection()">â• æ·»åŠ æ–°åˆ†ç»„</button>
  <button onclick="saveConfig()">ğŸ’¾ ä¿å­˜åˆ° COS</button>
</div>

<footer>
  <p>ğŸ“Œ æ­¤é¡µé¢æ”¯æŒç¼–è¾‘å¹¶ä¿å­˜è‡³ COSï¼Œé€‚åˆå›¢é˜Ÿç¯å¢ƒç»Ÿä¸€ç®¡ç†ã€‚</p>
</footer>

<script>
  const CONFIG_URL = 'https://rough-wind-37be.dyw1618.workers.dev/env.json';
  const PRESIGN_ENDPOINT = 'https://cos-presign-worker.dyw1618.workers.dev/presign?key=env.json&type=put';

  let config = { title: '', sections: [] };

  async function loadConfig() {
    const status = document.getElementById('status');
    const title = document.getElementById('page-title');
    try {
      const res = await fetch(CONFIG_URL);
      if (!res.ok) throw new Error(`åŠ è½½å¤±è´¥ï¼š${res.status}`);
      config = await res.json();
      title.textContent = config.title || 'ç¯å¢ƒé“¾æ¥æ±‡æ€»';
      status.textContent = 'âœ… åŠ è½½æˆåŠŸ';
      renderConfig();
    } catch (err) {
      status.classList.add('error');
      status.textContent = 'âŒ åŠ è½½å¤±è´¥ï¼š' + err.message;
    }
  }

  function renderConfig() {
    const content = document.getElementById('content');
    content.innerHTML = '';
    config.sections.forEach((section, secIndex) => {
      const sec = document.createElement('section');
      const h2 = document.createElement('h2');
      h2.innerHTML = `<input type="text" value="${section.title}" onchange="updateSectionTitle(${secIndex}, this.value)">`;
      sec.appendChild(h2);

      section.items.forEach((item, itemIndex) => {
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
          <input type="text" value="${item.label}" onchange="updateItemLabel(${secIndex}, ${itemIndex}, this.value)">
          <input type="text" value="${item.url}" onchange="updateItemUrl(${secIndex}, ${itemIndex}, this.value)">
          <button onclick="removeItem(${secIndex}, ${itemIndex})">ğŸ—‘ åˆ é™¤</button>
        `;
        sec.appendChild(row);
      });

      const addBtn = document.createElement('button');
      addBtn.textContent = 'â• æ·»åŠ é“¾æ¥';
      addBtn.onclick = () => addItem(secIndex);
      sec.appendChild(addBtn);

      content.appendChild(sec);
    });
  }

  function updateSectionTitle(index, value) {
    config.sections[index].title = value;
  }

  function updateItemLabel(secIndex, itemIndex, value) {
    config.sections[secIndex].items[itemIndex].label = value;
  }

  function updateItemUrl(secIndex, itemIndex, value) {
    config.sections[secIndex].items[itemIndex].url = value;
  }

  function addItem(secIndex) {
    config.sections[secIndex].items.push({ label: '', url: '' });
    renderConfig();
  }

  function removeItem(secIndex, itemIndex) {
    config.sections[secIndex].items.splice(itemIndex, 1);
    renderConfig();
  }

  function addSection() {
    config.sections.push({ title: 'æ–°åˆ†ç»„', items: [] });
    renderConfig();
  }

  async function saveConfig() {
    const status = document.getElementById('status');
    try {
      status.classList.remove('error');
      status.textContent = 'ğŸŒ€ è·å–ç­¾åä¸­...';
      const res = await fetch(PRESIGN_ENDPOINT);
      const { url } = await res.json();

      status.textContent = 'ğŸ“¤ å†™å…¥ä¸­...';
      const putRes = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config, null, 2),
      });

      if (!putRes.ok) throw new Error(`å†™å…¥å¤±è´¥ï¼š${putRes.status}`);
      status.textContent = 'âœ… ä¿å­˜æˆåŠŸ';
    } catch (err) {
      status.classList.add('error');
      status.textContent = 'âŒ ä¿å­˜å¤±è´¥ï¼š' + err.message;
    }
  }

  loadConfig();
</script>

</body>
</html>
